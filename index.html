<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyQuest</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <header>
    <h1 class="center-title">StudyQuest</h1>
  </header>
  <nav id="navbar" class="navbar horizontal-navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a href="index.html" class="nav-link">
          <i class="fas fa-tasks"></i>
          <span class="link-text">Quests</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="chat.html" class="nav-link">
          <i class="fas fa-robot"></i>
          <span class="link-text">AI Buddy</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="resources.html" class="nav-link">
          <i class="fas fa-book"></i>
          <span class="link-text">Resources</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="notemaking.html" class="nav-link">
          <i class="fas fa-book"></i>
          <span class="link-text">Notes</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="knowledge_map_page.html" class="nav-link">
          <i class="fas fa-map"></i> <span class="link-text">Knowledge Map</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link logout-link" id="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          <span class="link-text">Logout</span>
        </a>
      </li>
      
    </ul>
  </nav>
  <div class="container">
    <aside>
      <div class="player-profile">
        <h2>Player Stats</h2>
        <div class="player-stats">
          <div id="player-level" class="player-level"></div>
          <div class="xp-bar-container">
            <div id="xp-bar" class="xp-bar"></div>
          </div>
          <div id="xp-text" class="xp-text"></div>
        </div>
        <h2>Achievements</h2>
        <ul class="achievements-list">
          <li id="quest-badge-1" class="achievement">
            <span class="achievement-icon">醇</span>
            <span class="achievement-name">First Quest</span>
          </li>
          <li class="achievement">
            <span class="achievement-icon">白</span>
            <span class="achievement-name">Math Master</span>
          </li>
          <li class="achievement">
            <span class="achievement-icon">白</span>
            <span class="achievement-name">History Buff</span>
          </li>
        </ul>
      </div>
    </aside>
    <main>
      <div class="main-content">
        <section class="quest-board">
          <h2>Available Quests</h2>
          <div class="quest-search">
            <input type="text" id="quest-search-input" placeholder="Search quests by title...">
            <button id="search-quests-btn">Search</button>
          </div>
          <div class="quest-list" id="quest-list"></div>
        </section>
        <section class="profile-section">
          <button class="level-profile-btn" id="profile-button">
            <span class="badge-icon"><span id="level-number"></span></span>
          </button>
          <div class="calendar-container">
            <div class="calendar-header">
              <button id="prev-month" class="nav-btn"><</button>
              <span id="current-month">September 2025</span>
              <button id="next-month" class="nav-btn">></button>
            </div>
            <div class="calendar">
              <div class="weekdays">
                <div class="weekday">S</div>
                <div class="weekday">M</div>
                <div class="weekday">T</div>
                <div class="weekday">W</div>
                <div class="weekday">T</div>
                <div class="weekday">F</div>
                <div class="weekday">S</div>
              </div>
              <div class="days" id="calendar-days"></div>
            </div>
            <div class="premium-section">
              <div class="premium-header">
                <span>Weekly Premium</span>
                <span class="premium-time">3 days left</span>
              </div>
              <div class="premium-weeks">
                <div class="week">W1</div>
                <div class="week">W2</div>
                <div class="week">W3</div>
                <div class="week active">W4</div>
                <div class="week">W5</div>
              </div>
            </div>
            <div class="redeem-section">
              <span class="redeem-count">0</span>
              <span class="redeem-text">Redeem</span>
              <span class="rules-text">Rules</span>
            </div>
          </div>
        </section>
      </div>
    </main>
    <div id="profile-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Manage Subjects</h2>
        <div id="subject-list"></div>
        <input type="text" id="new-subject-input" placeholder="Add new subject">
        <button id="add-subject-modal-btn">Add Subject</button>
      </div>
    </div>
  </div>
<script>
  const API_URL = "https://mindbender4-0.onrender.com"; // Ensure this matches your deployed backend URL

  // Function to check session and redirect if unauthorized
  async function checkSession() {
    try {
      const res = await fetch(`${API_URL}/api/me`, {
        method: "GET",
        headers: { 
            "Content-Type": "application/json",
            "Cache-Control": "no-cache" 
        },
        credentials: 'include',
      });

      if (!res.ok) {
        // If session is not valid, redirect to login page
        window.location.href = "login.html";
      }
      // If res.ok, session is valid, no action needed (user stays on page)
    } catch (error) {
      console.error("Session check failed:", error);
      window.location.href = "login.html"; // Redirect on network error
    }
  }

  // Call checkSession when the page loads
  document.addEventListener("DOMContentLoaded", checkSession);

  // Logout functionality
  document.getElementById("logout-btn").addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch(`${API_URL}/logout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
      });

      if (res.ok) {
        window.location.href = "login.html";
      } else {
        const data = await res.json();
        alert("Logout failed: " + (data.message || "Unknown error"));
      }
    } catch (error) {
      console.error("Logout error:", error);
      alert("Logout error: " + error.message);
    }
  });

  // --- Player Stats Logic ---
  let player = {
    level: 0, 
    xp: 0,    
    xpToNextLevel: 100, 
  };

  const levelDisplay = document.getElementById('player-level');
  const levelNumber = document.getElementById('level-number');
  const xpText = document.getElementById('xp-text');
  const xpBar = document.getElementById('xp-bar');
  const firstQuestBadge = document.getElementById('quest-badge-1');

  function updateUI() {
    levelDisplay.textContent = `Level ${player.level}`;
    levelNumber.textContent = player.level;
    const xpPercentage = (player.xp / player.xpToNextLevel) * 100;
    xpBar.style.width = `${xpPercentage}%`;
    xpText.textContent = `${player.xp} / ${player.xpToNextLevel} XP`;

    fetchAndRenderQuests();
    renderSubjectsInModal();
    renderCalendar();
  }

  async function fetchPlayerStats() {
    try {
      const res = await fetch(`${API_URL}/api/me`, {
        method: "GET",
        headers: { 
            "Content-Type": "application/json",
            "Cache-Control": "no-cache" // FIX: Prevent browser from using old data
        },
        credentials: 'include',
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      const { studentInfo } = await res.json();

      player.level = studentInfo.level;
      player.xp = studentInfo.xp;

      // Recalculate xpToNextLevel based on the fetched level
      let base_xp_to_next_level = 100 + (studentInfo.student_id % 10); // Match server-side logic
      player.xpToNextLevel = base_xp_to_next_level;
      for (let i = 1; i < player.level; i++) {
        player.xpToNextLevel = Math.floor(player.xpToNextLevel * 1.5);
      }
    } catch (error) {
      console.error("Error fetching player stats:", error);
    }
  }

  // --- Other Functionalities ---
  let streakData = JSON.parse(localStorage.getItem('streakData')) || {};
  let subjects = JSON.parse(localStorage.getItem('subjects')) || [];

  const questSearchInput = document.getElementById('quest-search-input');
  const searchQuestsBtn = document.getElementById('search-quests-btn');
  const questListDiv = document.getElementById('quest-list');

  const profileButton = document.getElementById('profile-button');
  const profileModal = document.getElementById('profile-modal');
  const closeModalButton = document.querySelector('.close-button');
  const subjectListDiv = document.getElementById('subject-list');
  const newSubjectInput = document.getElementById('new-subject-input');
  const addSubjectModalBtn = document.getElementById('add-subject-modal-btn');

  const calendarDays = document.getElementById('calendar-days');
  const currentMonthSpan = document.getElementById('current-month');
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');

  let currentDate = new Date();
  let currentMonth = currentDate.getMonth();
  let currentYear = currentDate.getFullYear();

  function renderCalendar() {
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    calendarDays.innerHTML = '';
    for (let i = 0; i < firstDay; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.classList.add('day', 'empty');
      calendarDays.appendChild(emptyDay);
    }
    for (let day = 1; day <= daysInMonth; day++) {
      const dayElement = document.createElement('div');
      dayElement.classList.add('day');
      dayElement.textContent = day;
      const dateKey = `${currentYear}-${currentMonth + 1}-${day}`;
      if (streakData[dateKey]) {
        if (streakData[dateKey] === 'completed') dayElement.classList.add('completed');
        else if (streakData[dateKey] === 'missed') dayElement.classList.add('missed');
      }
      if (day === currentDate.getDate() &&
          currentMonth === currentDate.getMonth() &&
          currentYear === currentDate.getFullYear()) {
        dayElement.classList.add('today');
      }
      calendarDays.appendChild(dayElement);
    }
    const monthNames = ['January','February','March','April','May','June',
      'July','August','September','October','November','December'];
    currentMonthSpan.textContent = `${monthNames[currentMonth]} ${currentYear}`;
  }

  function saveSubjects() { localStorage.setItem('subjects', JSON.stringify(subjects)); }

  async function fetchAndRenderQuests(searchQuery = '') {
    questListDiv.innerHTML = '<p>Loading quests...</p>';
    try {
      const url = searchQuery ? `${API_URL}/api/quests?search=${encodeURIComponent(searchQuery)}` : `${API_URL}/api/quests`;
      const res = await fetch(url, {
        method: "GET",
        headers: { 
            "Content-Type": "application/json",
            "Cache-Control": "no-cache" // FIX: Prevent browser from using old data
        },
        credentials: 'include',
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      const responseData = await res.json();
      const { quests } = responseData;
      renderQuests(quests);
    } catch (error) {
      console.error("Error fetching quests:", error);
      questListDiv.innerHTML = '<p>Failed to load quests. Please try again.</p>';
    }
  }

  function renderQuests(quests) {
    questListDiv.innerHTML = '';
    if (!quests || quests.length === 0) {
      questListDiv.innerHTML = '<p>No quests found.</p>';
      return;
    }
    quests.forEach(quest => {
      const questCard = document.createElement('div');
      questCard.classList.add('quest-card');
      questCard.innerHTML = `
        <h3>Quest: ${quest.title}</h3>
        <p>Due: ${quest.due_date ? new Date(quest.due_date).toLocaleDateString() : 'N/A'}</p>
        <p>Subject: ${quest.subject || 'N/A'}</p>
        <p>Importance: ${quest.importance || 'N/A'}</p>
        <p>XP Reward: ${quest.xp_reward || 0}</p>
        <button class="complete-quest-btn" data-id="${quest.quest_id}">Complete Quest</button>
      `;
      questListDiv.appendChild(questCard);
    });
    document.querySelectorAll('.complete-quest-btn').forEach(button => {
      button.addEventListener('click', event => {
        const questId = event.target.dataset.id;
        completeQuest(questId);
      });
    });
  }

  async function completeQuest(questId) {
    try {
      const res = await fetch(`${API_URL}/api/quests/${questId}/complete`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
      });

      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || `HTTP error! status: ${res.status}`);
      }

      const data = await res.json();
      alert(data.message);
      
      await fetchPlayerStats();
      updateUI(); 
    } catch (error) {
      console.error("Error completing quest:", error);
      alert("Failed to complete quest: " + error.message);
    }
  }

  function openProfileModal() {
    profileModal.style.display = 'block';
    renderSubjectsInModal();
  }
  function closeProfileModal() { profileModal.style.display = 'none'; }
  function renderSubjectsInModal() {
    subjectListDiv.innerHTML = '';
    if (subjects.length === 0) {
      subjectListDiv.innerHTML = '<p>No subjects added yet.</p>';
      return;
    }
    subjects.forEach((subject, index) => {
      const subjectItem = document.createElement('div');
      subjectItem.classList.add('subject-item');
      subjectItem.innerHTML = `
        <span>${subject}</span>
        <button class="delete-subject-btn" data-index="${index}">Delete</button>
      `;
      subjectListDiv.appendChild(subjectItem);
    });
    document.querySelectorAll('.delete-subject-btn').forEach(button => {
      button.addEventListener('click', event => {
        const index = event.target.dataset.index;
        deleteSubject(index);
      });
    });
  }
  function addSubjectFromModal() {
    const newSubject = newSubjectInput.value.trim();
    if (newSubject && !subjects.includes(newSubject)) {
      subjects.push(newSubject);
      saveSubjects();
      newSubjectInput.value = '';
      updateUI();
    } else if (subjects.includes(newSubject)) {
      alert('Subject already exists!');
    }
  }

  function deleteSubject(index) {
    if (confirm(`Are you sure you want to delete "${subjects[index]}"?`)) {
      subjects.splice(index, 1);
      saveSubjects();
      updateUI();
    }
  }

  searchQuestsBtn.addEventListener('click', () => {
    const searchQuery = questSearchInput.value.trim();
    fetchAndRenderQuests(searchQuery);
  });

  profileButton.addEventListener('click', openProfileModal);
  closeModalButton.addEventListener('click', closeProfileModal);
  addSubjectModalBtn.addEventListener('click', addSubjectFromModal);

  prevMonthBtn.addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  });
  nextMonthBtn.addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
  });
  window.addEventListener('click', event => {
    if (event.target === profileModal) closeProfileModal();
  });

  document.querySelectorAll('.logout-link').forEach(el => el.addEventListener('click', () => {
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
  }));

  document.addEventListener('DOMContentLoaded', () => {
    fetchPlayerStats().then(() => {
      updateUI();
    });
  });
</script>
</body>
</html>
